#!/usr/bin/env lsc
assert = require 'assert'
SimpleStream = require 'SimpleStream'
{M, expect} = require 'util.ls'

S = new SimpleStream

# fail when things go wrong
check-fail = ->
  try
    stopListening = expect S, S.once, 'data', ['hey']
    S.write Buffer.from 'blah hey'
    stopListening()
  catch
    M "[PASS] there was a fail"
    return
  assert false
# check-fail!

# rest should succeed
stopListening = expect S, S.once, 'data', ['hey']
S.write Buffer.from 'hey'
stopListening()

stopListening = expect S, S.on, 'data', ['hey', 'there']
S.write Buffer.from 'hey'
S.write Buffer.from 'there'
stopListening()
S.write Buffer.from 'blah'  # no error means .off worked

failIfFired = (d) -> M "never emit:"; M d; assert false
S.on 'data', failIfFired
S.write Buffer.from ''
S.off 'data', failIfFired
S.write Buffer.from 'should not fail'
