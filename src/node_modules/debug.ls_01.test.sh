#!/bin/bash
set -e

# utility
function log2msgs {
  cat $1 | sed 's/^.\{12\}//g'
}
GOLDLOG=$(mktemp)
echo test message | src/log.ls $GOLDLOG > /dev/null


# \TEST00 DBG=stdin consumes log on stdin
SCRATCH=$(mktemp)
cat $GOLDLOG | DBG=stdin src/filter0.ls > $SCRATCH
[ "$(cat $SCRATCH)" = "test message" ]


# \TEST01 DBG=stdout emits log on stdout
SCRATCH=$(mktemp)
echo test message | DBG=stdout src/filter0.ls > $SCRATCH
cmp <(log2msgs $GOLDLOG) <(log2msgs $SCRATCH)


# \TEST02 DBG=all consumes, emits log on stdin, stdout
SCRATCH=$(mktemp)
cat $GOLDLOG | DBG=all src/filter0.ls > $SCRATCH
cmp <(log2msgs $GOLDLOG) <(log2msgs $SCRATCH)
