#!/bin/bash
set -e


TEMP=$(mktemp)
echo $TEMP
for I in {0..3} ; do
  echo $I
  sleep 1s
done | src/log.ls $TEMP

function log2msgs {
  cat $1 | sed 's/^.\{12\}//g'
}

# \TEST00 DBG stdin converts stdin but not stdout
TEMP2=$(mktemp)
for I in {1..4} ; do
  sed -n ${I}p $TEMP
  sleep 1s
done | DBG=stdin src/filter0.ls | src/log.ls $TEMP2
cmp <(log2msgs $TEMP) <(log2msgs $TEMP2)

# \TEST01 DBG all on passthru is still passthru, but in logs
TEMP2=$(mktemp)
cat $TEMP | DBG=all src/filter0.ls > $TEMP2
cmp <(log2msgs $TEMP) <(log2msgs $TEMP2)
